<!doctype html>
<html lang="en" class="h-full bg-neutral-950 antialiased">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Braven Lab Dashboard</title>
    <script src="/js/tailwind.js"></script>
    <script src="/js/lucide.min.js"></script>
    <style>
      @font-face {
        font-family: "Inter";
        font-style: normal;
        font-weight: 300;
        src: url("/fonts/inter-300.ttf") format("truetype");
      }
      @font-face {
        font-family: "Inter";
        font-style: normal;
        font-weight: 400;
        src: url("/fonts/inter-400.ttf") format("truetype");
      }
      @font-face {
        font-family: "Inter";
        font-style: normal;
        font-weight: 500;
        src: url("/fonts/inter-500.ttf") format("truetype");
      }
      @font-face {
        font-family: "Inter";
        font-style: normal;
        font-weight: 600;
        src: url("/fonts/inter-600.ttf") format("truetype");
      }
      @font-face {
        font-family: "Inter";
        font-style: normal;
        font-weight: 700;
        src: url("/fonts/inter-600.ttf") format("truetype");
      }
      .no-scrollbar::-webkit-scrollbar {
        display: none;
      }
      .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
    </style>
    <script>
      tailwind.config = {
        theme: {
          fontFamily: {
            sans: ["Inter", "sans-serif"],
            mono: [
              "ui-monospace",
              "SFMono-Regular",
              "Menlo",
              "Monaco",
              "Consolas",
              "monospace",
            ],
          },
          extend: {
            colors: {
              karoo: { yellow: "#FFD700", purple: "#8B5CF6" },
            },
            keyframes: {
              pulsefast: {
                "0%, 100%": { opacity: "1" },
                "50%": { opacity: "0.4" },
              },
            },
            animation: {
              pulsefast: "pulsefast 2s cubic-bezier(0.4, 0, 0.6, 1) infinite",
            },
          },
        },
      };
    </script>
  </head>
  <body
    class="h-full flex flex-col text-neutral-100 overflow-hidden selection:bg-karoo-yellow selection:text-black"
  >
    <!-- Hidden refs for compact stats (removed from UI) -->
    <div class="hidden">
      <span id="elapsedTime">00:00:00</span>
      <span id="lapNumber">1</span>
      <span id="lapTime">00:00</span>
      <span id="distance">0.00 km</span>
      <i id="batteryIcon" data-lucide="battery"></i>
      <span id="batteryPercent">--%</span>
    </div>

    <!-- ═══════════════ TIME STRIP - Session & Lap Timers ═══════════════ -->
    <div
      class="flex-none flex items-center justify-between px-6 py-3 bg-neutral-900/50 border-b border-white/5"
    >
      <!-- Connection Badge + Title -->
      <div class="flex items-center gap-4">
        <div
          id="connectionBadge"
          class="flex items-center gap-2 px-3 py-1 rounded-full bg-red-500/10 border border-red-500/20"
        >
          <span class="relative flex h-2 w-2">
            <span
              id="pingDot"
              class="absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"
            ></span>
            <span
              id="solidDot"
              class="relative inline-flex rounded-full h-2 w-2 bg-red-500"
            ></span>
          </span>
          <span
            id="connectionText"
            class="text-xs font-medium text-red-500 tracking-wide uppercase"
            >Disconnected</span
          >
        </div>
        <h1 class="text-base font-medium text-neutral-500 tracking-tight">
          Braven Performance Lab
        </h1>
      </div>

      <!-- Timers (centered) -->
      <div class="flex items-center gap-12">
        <div class="flex items-center gap-3">
          <div class="flex items-center gap-2 text-neutral-500">
            <i data-lucide="timer" class="w-5 h-5"></i>
            <span class="text-sm font-medium uppercase tracking-wide"
              >Session</span
            >
          </div>
          <span
            id="sessionTime"
            class="text-3xl font-bold tabular-nums text-white tracking-tight"
            >00:00:00</span
          >
        </div>

        <!-- Divider -->
        <div class="h-8 w-px bg-white/10"></div>

        <!-- Lap Time -->
        <div class="flex items-center gap-3">
          <div class="flex items-center gap-2 text-neutral-500">
            <i data-lucide="flag" class="w-5 h-5"></i>
            <span class="text-sm font-medium uppercase tracking-wide"
              >Lap <span id="lapNumberBig" class="text-amber-400">1</span></span
            >
          </div>
          <span
            id="lapTimeBig"
            class="text-3xl font-bold tabular-nums text-amber-400 tracking-tight"
            >00:00</span
          >
        </div>
      </div>
    </div>

    <!-- Main Dashboard - Primary Metrics Focus -->
    <main
      class="flex-grow p-4 grid gap-4 relative overflow-hidden"
      style="
        grid-template-columns: 3fr 3fr 2fr 2fr;
        grid-template-rows: 1fr 1fr 1fr 1fr;
      "
    >
      <!-- Background glow -->
      <div
        class="absolute top-1/3 left-1/4 w-[600px] h-[600px] bg-purple-900/20 rounded-full blur-[150px] pointer-events-none"
      ></div>
      <div
        class="absolute bottom-1/3 right-1/4 w-[400px] h-[400px] bg-rose-900/15 rounded-full blur-[120px] pointer-events-none"
      ></div>

      <!-- ═══════════════ POWER - Primary Metric (2 columns) ═══════════════ -->
      <div
        class="col-span-2 row-span-2 relative flex flex-col rounded-3xl bg-gradient-to-br from-purple-950/40 to-neutral-900/60 border border-purple-500/20 p-6 backdrop-blur-sm overflow-hidden"
      >
        <div
          class="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-purple-500 via-violet-500 to-indigo-500"
        ></div>

        <!-- Header -->
        <div class="flex items-center justify-between mb-2">
          <div class="flex items-center gap-3">
            <div class="p-2.5 rounded-xl bg-purple-500/20 text-purple-400">
              <i data-lucide="zap" class="w-6 h-6"></i>
            </div>
            <div>
              <span
                class="text-sm font-semibold tracking-widest text-purple-400 uppercase"
                >Power Output</span
              >
              <div class="text-xs text-neutral-500">Primary Metric</div>
            </div>
          </div>
          <span
            id="powerZoneBadge"
            class="text-sm font-bold text-purple-300 bg-purple-500/20 px-3 py-1 rounded-lg"
            >--</span
          >
        </div>

        <!-- Main Values -->
        <div class="flex items-end gap-8 my-4">
          <div class="flex-1">
            <div class="text-xs text-neutral-500 uppercase tracking-wider mb-1">
              Instant
            </div>
            <div class="flex items-baseline gap-2">
              <span
                id="power"
                class="text-8xl font-bold tracking-tighter text-white tabular-nums leading-none"
                >--</span
              >
              <span class="text-2xl text-neutral-500 font-medium">W</span>
            </div>
          </div>
          <div class="flex-1">
            <div class="text-xs text-neutral-500 uppercase tracking-wider mb-1">
              3s Average
            </div>
            <div class="flex items-baseline gap-2">
              <span
                id="power3sAvg"
                class="text-7xl font-bold tracking-tighter text-purple-300 tabular-nums leading-none"
                >--</span
              >
              <span class="text-xl text-neutral-500 font-medium">W</span>
            </div>
          </div>
        </div>

        <!-- Lap Power Stats -->
        <div class="flex gap-6 text-sm mb-4 px-1">
          <div>
            <span class="text-neutral-500">Lap Avg:</span>
            <span
              id="lapPower"
              class="text-white font-semibold tabular-nums ml-1"
              >-- W</span
            >
          </div>
          <div>
            <span class="text-neutral-500">Lap NP:</span>
            <span
              id="lapNormalizedPower"
              class="text-white font-semibold tabular-nums ml-1"
              >-- W</span
            >
          </div>
          <div>
            <span class="text-neutral-500">Lap Max:</span>
            <span
              id="lapMaxPower"
              class="text-white font-semibold tabular-nums ml-1"
              >-- W</span
            >
          </div>
        </div>

        <!-- Power Graph -->
        <div class="flex-grow relative mt-2 min-h-[120px]">
          <canvas id="powerGraph" class="w-full h-full"></canvas>
          <div
            class="absolute bottom-0 left-0 right-0 h-8 bg-gradient-to-t from-purple-950/60 to-transparent pointer-events-none"
          ></div>
        </div>
      </div>

      <!-- ═══════════════ VO2 - Placeholder (1 column) ═══════════════ -->
      <div
        class="row-start-3 relative flex flex-col rounded-3xl bg-gradient-to-br from-cyan-950/40 to-neutral-900/60 border border-cyan-500/20 p-5 backdrop-blur-sm overflow-hidden"
      >
        <div
          class="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-cyan-500 to-teal-500"
        ></div>

        <!-- Header -->
        <div class="flex items-center justify-between mb-2">
          <div class="flex items-center gap-2">
            <div class="p-2 rounded-xl bg-cyan-500/20 text-cyan-400">
              <i data-lucide="wind" class="w-5 h-5"></i>
            </div>
            <span
              class="text-xs font-semibold tracking-widest text-cyan-400 uppercase"
              >VO2</span
            >
          </div>
          <span id="vo2LiveBadge" class="text-xs font-medium text-neutral-500"
            >Pending</span
          >
        </div>

        <!-- Main Value -->
        <div class="flex items-baseline gap-1 my-2">
          <span
            id="vo2"
            class="text-6xl font-bold tracking-tighter text-white tabular-nums"
            >--</span
          >
          <span class="text-lg text-neutral-500 font-medium">ml/kg/min</span>
        </div>

        <!-- VO2 Max Reference -->
        <div class="text-sm text-neutral-500 mb-3">
          <span>% of Max:</span>
          <span id="vo2Percent" class="text-cyan-400 font-semibold ml-1"
            >--%</span
          >
        </div>

        <!-- VO2 Graph -->
        <div class="flex-grow relative min-h-[80px]">
          <canvas id="vo2Graph" class="w-full h-full"></canvas>
        </div>
      </div>

      <!-- ═══════════════ HEART RATE (1 column) ═══════════════ -->
      <div
        class="row-start-3 relative flex flex-col rounded-3xl bg-gradient-to-br from-rose-950/40 to-neutral-900/60 border border-rose-500/20 p-5 backdrop-blur-sm overflow-hidden"
      >
        <div
          class="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-rose-500 to-red-600"
        ></div>

        <!-- Header -->
        <div class="flex items-center justify-between mb-2">
          <div class="flex items-center gap-2">
            <div class="p-2 rounded-xl bg-rose-500/20 text-rose-400">
              <i data-lucide="heart" class="w-5 h-5"></i>
            </div>
            <span
              class="text-xs font-semibold tracking-widest text-rose-400 uppercase"
              >Heart Rate</span
            >
          </div>
          <span
            id="hrLiveBadge"
            class="text-xs font-medium text-rose-400 animate-pulsefast"
            >Live</span
          >
        </div>

        <!-- Main Value -->
        <div class="flex items-baseline gap-1 my-2">
          <span
            id="heartRate"
            class="text-6xl font-bold tracking-tighter text-white tabular-nums"
            >--</span
          >
          <span class="text-lg text-neutral-500 font-medium">BPM</span>
        </div>

        <!-- HR Stats -->
        <div class="flex gap-4 text-sm text-neutral-500 mb-3">
          <div>
            Max:
            <span id="maxHeartRate" class="text-white font-semibold">--</span>
          </div>
          <div>
            Lap:
            <span id="lapHeartRate" class="text-white font-semibold">--</span>
          </div>
        </div>

        <!-- HR Graph -->
        <div class="flex-grow relative min-h-[80px]">
          <canvas id="hrGraph" class="w-full h-full"></canvas>
        </div>
      </div>

      <!-- ═══════════════ CADENCE (1 column) ═══════════════ -->
      <div
        class="row-start-4 relative flex flex-col rounded-3xl bg-gradient-to-br from-blue-950/40 to-neutral-900/60 border border-blue-500/20 p-5 backdrop-blur-sm overflow-hidden"
      >
        <div
          class="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-blue-400 to-cyan-400"
        ></div>

        <!-- Header -->
        <div class="flex items-center gap-2 mb-2">
          <div class="p-2 rounded-xl bg-blue-500/20 text-blue-400">
            <i data-lucide="rotate-cw" class="w-5 h-5"></i>
          </div>
          <span
            class="text-xs font-semibold tracking-widest text-blue-400 uppercase"
            >Cadence</span
          >
        </div>

        <!-- Main Value -->
        <div class="flex items-baseline gap-1 my-2">
          <span
            id="cadence"
            class="text-6xl font-bold tracking-tighter text-white tabular-nums"
            >--</span
          >
          <span class="text-lg text-neutral-500 font-medium">RPM</span>
        </div>

        <!-- Cadence Stats -->
        <div class="flex gap-4 text-sm text-neutral-500 mb-3">
          <div>
            Avg:
            <span id="avgCadence" class="text-white font-semibold">--</span>
          </div>
          <div>
            Lap:
            <span id="lapCadence" class="text-white font-semibold">--</span>
          </div>
        </div>

        <!-- Cadence Graph -->
        <div class="flex-grow relative min-h-[80px]">
          <canvas id="cadenceGraph" class="w-full h-full"></canvas>
        </div>
      </div>

      <!-- ═══════════════ SPEED (1 column) ═══════════════ -->
      <div
        class="row-start-4 relative flex flex-col rounded-3xl bg-gradient-to-br from-emerald-950/30 to-neutral-900/60 border border-emerald-500/10 p-5 backdrop-blur-sm overflow-hidden"
      >
        <div
          class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-emerald-500 to-green-500 opacity-60"
        ></div>

        <!-- Header -->
        <div class="flex items-center gap-2 mb-2">
          <div class="p-2 rounded-xl bg-emerald-500/10 text-emerald-400">
            <i data-lucide="gauge" class="w-5 h-5"></i>
          </div>
          <span
            class="text-xs font-medium tracking-widest text-emerald-400/70 uppercase"
            >Speed</span
          >
        </div>

        <!-- Main Value -->
        <div class="flex items-baseline gap-1 my-1">
          <span
            id="speed"
            class="text-5xl font-bold tracking-tighter text-white tabular-nums"
            >--</span
          >
          <span class="text-base text-neutral-500 font-medium">KPH</span>
        </div>

        <!-- Speed Stats -->
        <div class="flex gap-4 text-xs text-neutral-500 mt-auto">
          <div>Avg: <span id="averageSpeed" class="text-white">--</span></div>
          <div>Lap: <span id="lapSpeed" class="text-white">--</span></div>
        </div>
      </div>

      <!-- ═══════════════ LAP HISTORY & CAPTURE ROW ═══════════════ -->

      <!-- Lap History Table (full width) -->
      <div
        class="col-span-2 row-span-2 col-start-3 row-start-1 relative flex flex-col rounded-2xl bg-neutral-900/30 border border-white/5 p-4 backdrop-blur-sm"
      >
        <div class="flex items-center justify-between mb-3">
          <div class="flex items-center gap-2">
            <div class="p-1.5 rounded-lg bg-amber-500/10 text-amber-400">
              <i data-lucide="list" class="w-4 h-4"></i>
            </div>
            <span
              class="text-xs font-medium tracking-wider text-neutral-500 uppercase"
              >Lap History</span
            >
          </div>
          <button
            id="newLapBtn"
            onclick="markNewLap()"
            class="flex items-center gap-1.5 px-3 py-1.5 text-xs font-semibold uppercase tracking-wide rounded-lg bg-amber-500/20 text-amber-400 border border-amber-500/30 hover:bg-amber-500/30 hover:border-amber-500/50 transition-colors"
          >
            <i data-lucide="flag" class="w-3.5 h-3.5"></i>
            New Lap
          </button>
        </div>
        <div
          class="overflow-auto max-h-48 scrollbar-thin scrollbar-thumb-neutral-700"
        >
          <table class="w-full text-sm">
            <thead
              class="sticky top-0 bg-neutral-900/90 text-neutral-400 text-xs uppercase"
            >
              <tr class="border-b border-neutral-700">
                <th class="px-3 py-2 text-left">Lap</th>
                <th class="px-3 py-2 text-left">Time</th>
                <th class="px-3 py-2 text-left">Power</th>
                <th class="px-3 py-2 text-left">HR</th>
                <th class="px-3 py-2 text-left">Cad</th>
                <th class="px-3 py-2 text-left">La</th>
              </tr>
            </thead>
            <tbody>
              <!-- Current lap (highlighted) -->
              <tr
                id="currentLapRow"
                class="border-b border-cyan-900/50 bg-cyan-950/30"
              >
                <td class="px-3 py-2 text-cyan-400 font-semibold">1</td>
                <td class="px-3 py-2 font-mono text-cyan-300">00:00</td>
                <td class="px-3 py-2 font-semibold text-cyan-400">--</td>
                <td class="px-3 py-2 text-cyan-300">--</td>
                <td class="px-3 py-2 text-cyan-300">--</td>
                <td class="px-3 py-2 text-cyan-300">--</td>
              </tr>
            </tbody>
            <!-- Completed laps (populated dynamically) -->
            <tbody id="lapListBody" class="text-neutral-300"></tbody>
          </table>
        </div>
      </div>

      <!-- Trainer Control (KICKR via BLE FTMS) -->
      <div
        class="col-span-2 col-start-3 row-start-4 relative flex flex-col rounded-2xl bg-neutral-900/30 border border-white/5 p-4 backdrop-blur-sm"
      >
        <div class="flex items-center gap-2 mb-2">
          <div class="p-1.5 rounded-lg bg-amber-500/10 text-amber-400">
            <i data-lucide="zap" class="w-4 h-4"></i>
          </div>
          <span
            class="text-xs font-medium tracking-wider text-neutral-500 uppercase"
            >Trainer Control</span
          >
          <span
            id="trainerStateBadge"
            class="ml-auto px-2 py-0.5 text-[10px] font-bold uppercase tracking-widest rounded-full bg-neutral-700/50 text-neutral-500"
            >Disconnected</span
          >
        </div>

        <!-- Scan / Device List / Connection -->
        <div id="trainerScanSection">
          <button
            id="trainerScanBtn"
            onclick="trainerScan()"
            class="w-full px-3 py-2 text-xs font-semibold uppercase tracking-wide rounded-lg bg-amber-500/20 text-amber-400 border border-amber-500/30 hover:bg-amber-500/30 hover:border-amber-500/50 transition-colors flex items-center justify-center gap-2"
          >
            <i data-lucide="bluetooth-searching" class="w-4 h-4"></i>
            Scan for Trainer
          </button>
          <div
            id="trainerDeviceList"
            class="mt-2 space-y-1 max-h-32 overflow-y-auto hidden"
          ></div>
        </div>

        <!-- Connected: ERG Target -->
        <div id="trainerControlSection" class="hidden">
          <div class="flex items-baseline gap-1 mb-2">
            <span
              id="trainerDeviceName"
              class="text-sm font-medium text-neutral-400 truncate"
              >--</span
            >
          </div>
          <div class="flex items-baseline gap-1 mb-3">
            <span
              id="trainerTargetDisplay"
              class="text-4xl font-bold tracking-tighter text-amber-400 tabular-nums"
              >--</span
            >
            <span class="text-sm text-neutral-500">W</span>
          </div>
          <div class="flex gap-2 mb-2">
            <input
              id="trainerPowerInput"
              type="number"
              step="5"
              min="0"
              max="2000"
              placeholder="e.g. 200"
              class="flex-1 px-3 py-1.5 rounded-lg bg-neutral-800/80 border border-neutral-700 text-white text-sm font-mono placeholder:text-neutral-600 focus:outline-none focus:border-amber-500/50 focus:ring-1 focus:ring-amber-500/20"
            />
            <button
              id="trainerSetPowerBtn"
              onclick="trainerSetPower()"
              class="px-3 py-1.5 text-xs font-semibold uppercase tracking-wide rounded-lg bg-amber-500/20 text-amber-400 border border-amber-500/30 hover:bg-amber-500/30 hover:border-amber-500/50 transition-colors"
            >
              Set
            </button>
          </div>
          <!-- Quick-set power buttons -->
          <div class="grid grid-cols-5 gap-1 mb-2">
            <button
              onclick="trainerQuickPower(100)"
              class="px-1 py-1 text-[10px] font-mono rounded bg-neutral-800/80 text-neutral-400 hover:bg-amber-500/20 hover:text-amber-400 transition-colors"
            >
              100
            </button>
            <button
              onclick="trainerQuickPower(150)"
              class="px-1 py-1 text-[10px] font-mono rounded bg-neutral-800/80 text-neutral-400 hover:bg-amber-500/20 hover:text-amber-400 transition-colors"
            >
              150
            </button>
            <button
              onclick="trainerQuickPower(200)"
              class="px-1 py-1 text-[10px] font-mono rounded bg-neutral-800/80 text-neutral-400 hover:bg-amber-500/20 hover:text-amber-400 transition-colors"
            >
              200
            </button>
            <button
              onclick="trainerQuickPower(250)"
              class="px-1 py-1 text-[10px] font-mono rounded bg-neutral-800/80 text-neutral-400 hover:bg-amber-500/20 hover:text-amber-400 transition-colors"
            >
              250
            </button>
            <button
              onclick="trainerQuickPower(300)"
              class="px-1 py-1 text-[10px] font-mono rounded bg-neutral-800/80 text-neutral-400 hover:bg-amber-500/20 hover:text-amber-400 transition-colors"
            >
              300
            </button>
          </div>
          <!-- +/- increment buttons -->
          <div class="flex gap-2 mb-2">
            <button
              onclick="trainerAdjustPower(-25)"
              class="flex-1 px-2 py-1.5 text-xs font-semibold rounded-lg bg-neutral-800/80 text-neutral-400 hover:bg-red-500/20 hover:text-red-400 border border-neutral-700 hover:border-red-500/30 transition-colors"
            >
              -25 W
            </button>
            <button
              onclick="trainerAdjustPower(-5)"
              class="flex-1 px-2 py-1.5 text-xs font-semibold rounded-lg bg-neutral-800/80 text-neutral-400 hover:bg-red-500/20 hover:text-red-400 border border-neutral-700 hover:border-red-500/30 transition-colors"
            >
              -5 W
            </button>
            <button
              onclick="trainerAdjustPower(5)"
              class="flex-1 px-2 py-1.5 text-xs font-semibold rounded-lg bg-neutral-800/80 text-neutral-400 hover:bg-green-500/20 hover:text-green-400 border border-neutral-700 hover:border-green-500/30 transition-colors"
            >
              +5 W
            </button>
            <button
              onclick="trainerAdjustPower(25)"
              class="flex-1 px-2 py-1.5 text-xs font-semibold rounded-lg bg-neutral-800/80 text-neutral-400 hover:bg-green-500/20 hover:text-green-400 border border-neutral-700 hover:border-green-500/30 transition-colors"
            >
              +25 W
            </button>
          </div>
          <button
            onclick="trainerDisconnect()"
            class="w-full px-3 py-1.5 text-xs font-semibold uppercase tracking-wide rounded-lg bg-neutral-800/50 text-neutral-500 border border-neutral-700 hover:bg-red-500/10 hover:text-red-400 hover:border-red-500/30 transition-colors"
          >
            Disconnect
          </button>
        </div>

        <div id="trainerError" class="text-xs text-red-400 mt-2 hidden"></div>
      </div>

      <!-- Lactate Entry -->
      <div
        class="row-start-3 col-start-3 col-span-2 relative flex rounded-2xl bg-neutral-900/30 border border-white/5 p-4 backdrop-blur-sm gap-4"
      >
        <!-- Left column: header + big value -->
        <div class="flex flex-col justify-between flex-1 min-w-0">
          <div class="flex items-center gap-2 mb-1">
            <div class="p-1.5 rounded-lg bg-rose-500/10 text-rose-400">
              <i data-lucide="droplet" class="w-4 h-4"></i>
            </div>
            <span
              class="text-xs font-medium tracking-wider text-rose-400 uppercase"
              >LACTATE</span
            >
          </div>
          <div class="flex items-baseline gap-1">
            <span
              id="lactateValue"
              class="text-6xl font-bold tracking-tighter text-white tabular-nums"
              >--</span
            >
            <span class="text-sm text-neutral-500">mmol/L</span>
          </div>
          <div
            id="lactateTimestamp"
            class="text-xs text-neutral-500 mt-1"
          ></div>
        </div>
        <!-- Right column: stepper controls -->
        <div class="flex items-center justify-center gap-2 shrink-0">
          <!-- Whole digit -->
          <div class="flex flex-col items-center gap-1.5">
            <button
              onclick="lactateStep('whole', 1)"
              class="w-14 h-10 flex items-center justify-center rounded-lg bg-neutral-800/80 border border-neutral-700 text-neutral-400 hover:bg-neutral-700/80 hover:text-white transition-colors"
            >
              <i data-lucide="chevron-up" class="w-5 h-5"></i>
            </button>
            <div
              id="lactateWhole"
              class="w-14 h-14 flex items-center justify-center rounded-lg bg-neutral-800/80 border border-neutral-700 text-white text-2xl font-bold font-mono"
            >
              0
            </div>
            <button
              onclick="lactateStep('whole', -1)"
              class="w-14 h-10 flex items-center justify-center rounded-lg bg-neutral-800/80 border border-neutral-700 text-neutral-400 hover:bg-neutral-700/80 hover:text-white transition-colors"
            >
              <i data-lucide="chevron-down" class="w-5 h-5"></i>
            </button>
            <span
              class="text-[10px] font-medium tracking-wider text-neutral-500 uppercase"
              >WHOLE</span
            >
          </div>
          <!-- Dot -->
          <span class="text-2xl font-bold text-neutral-500 self-center -mt-6"
            >.</span
          >
          <!-- Decimal digit -->
          <div class="flex flex-col items-center gap-1.5">
            <button
              onclick="lactateStep('dec', 1)"
              class="w-14 h-10 flex items-center justify-center rounded-lg bg-neutral-800/80 border border-neutral-700 text-neutral-400 hover:bg-neutral-700/80 hover:text-white transition-colors"
            >
              <i data-lucide="chevron-up" class="w-5 h-5"></i>
            </button>
            <div
              id="lactateDec"
              class="w-14 h-14 flex items-center justify-center rounded-lg bg-neutral-800/80 border border-neutral-700 text-white text-2xl font-bold font-mono"
            >
              0
            </div>
            <button
              onclick="lactateStep('dec', -1)"
              class="w-14 h-10 flex items-center justify-center rounded-lg bg-neutral-800/80 border border-neutral-700 text-neutral-400 hover:bg-neutral-700/80 hover:text-white transition-colors"
            >
              <i data-lucide="chevron-down" class="w-5 h-5"></i>
            </button>
            <span
              class="text-[10px] font-medium tracking-wider text-neutral-500 uppercase"
              >DEC</span
            >
          </div>
          <!-- Submit -->
          <button
            id="lactateSubmitBtn"
            onclick="submitLactate()"
            class="w-16 h-14 flex items-center justify-center rounded-xl bg-rose-500/20 text-rose-400 border border-rose-500/30 hover:bg-rose-500/30 hover:border-rose-500/50 transition-colors self-center -mt-6 ml-1"
          >
            <i data-lucide="check" class="w-7 h-7"></i>
          </button>
        </div>
      </div>

      <!-- Hidden elements to keep JS refs intact -->
      <span id="temperature" class="hidden"></span>
      <span id="elevation" class="hidden"></span>
      <span id="grade" class="hidden"></span>
      <span id="coreTemp" class="hidden"></span>
      <span id="coreTempTrend" class="hidden"></span>
      <span id="latitude" class="hidden"></span>
      <span id="longitude" class="hidden"></span>
    </main>

    <!-- Minimal Footer -->
    <footer
      class="flex-none px-6 py-2 border-t border-white/5 bg-neutral-950 flex justify-between items-center text-neutral-600 text-xs"
    >
      <span id="lastUpdate" class="uppercase tracking-widest font-medium"
        >--</span
      >
      <span>Braven Performance Lab v1.0</span>
    </footer>

    <script src="/js/websocket-client.js"></script>
    <script src="/js/dashboard-renderer.js"></script>
    <script>
      // Initialize Lucide icons
      lucide.createIcons();

      // Initialize the dashboard
      const client = new BravenWebSocketClient();
      const renderer = new DashboardRenderer();

      client.onData((data) => {
        renderer.update(data);
      });

      client.onStatusChange((connected) => {
        renderer.setConnectionStatus(connected);
      });

      client.connect();

      /**
       * Mark a new lap on the Karoo via the API
       */
      async function markNewLap() {
        const btn = document.getElementById("newLapBtn");
        const originalHTML = btn.innerHTML;

        try {
          // Visual feedback
          btn.disabled = true;
          btn.innerHTML =
            '<i data-lucide="loader-2" class="w-3.5 h-3.5 animate-spin"></i> Marking...';
          lucide.createIcons({ nodes: btn.querySelectorAll("[data-lucide]") });

          const response = await fetch("/api/lap", { method: "POST" });
          const result = await response.json();

          if (result.success) {
            btn.innerHTML =
              '<i data-lucide="check" class="w-3.5 h-3.5"></i> Lap Marked!';
            btn.classList.remove(
              "text-amber-400",
              "bg-amber-500/20",
              "border-amber-500/30",
            );
            btn.classList.add(
              "text-green-400",
              "bg-green-500/20",
              "border-green-500/30",
            );
          } else {
            throw new Error(result.message || "Failed to mark lap");
          }
        } catch (err) {
          console.error("Failed to mark lap:", err);
          btn.innerHTML = '<i data-lucide="x" class="w-3.5 h-3.5"></i> Failed';
          btn.classList.remove(
            "text-amber-400",
            "bg-amber-500/20",
            "border-amber-500/30",
          );
          btn.classList.add(
            "text-red-400",
            "bg-red-500/20",
            "border-red-500/30",
          );
        }

        lucide.createIcons({ nodes: btn.querySelectorAll("[data-lucide]") });

        // Reset button after delay
        setTimeout(() => {
          btn.disabled = false;
          btn.innerHTML = originalHTML;
          btn.classList.remove(
            "text-green-400",
            "bg-green-500/20",
            "border-green-500/30",
            "text-red-400",
            "bg-red-500/20",
            "border-red-500/30",
          );
          btn.classList.add(
            "text-amber-400",
            "bg-amber-500/20",
            "border-amber-500/30",
          );
          lucide.createIcons({ nodes: btn.querySelectorAll("[data-lucide]") });
        }, 2000);
      }

      /**
       * Lactate stepper state
       */
      let _lactateWhole = 0;
      let _lactateDec = 0;

      function lactateStep(part, delta) {
        if (part === "whole") {
          _lactateWhole = Math.max(0, Math.min(50, _lactateWhole + delta));
          document.getElementById("lactateWhole").textContent = _lactateWhole;
        } else {
          _lactateDec = (((_lactateDec + delta) % 10) + 10) % 10;
          document.getElementById("lactateDec").textContent = _lactateDec;
        }
      }

      /**
       * Submit a lactate measurement via the API
       */
      async function submitLactate() {
        const btn = document.getElementById("lactateSubmitBtn");
        const value = _lactateWhole + _lactateDec * 0.1;

        if (value < 0 || value > 50) return;

        const originalHTML = btn.innerHTML;
        try {
          btn.disabled = true;
          btn.innerHTML =
            '<i data-lucide="loader-2" class="w-5 h-5 animate-spin"></i>';
          lucide.createIcons({ nodes: btn.querySelectorAll("[data-lucide]") });

          const response = await fetch("/api/lactate", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ value: value }),
          });
          const result = await response.json();

          if (result.success) {
            btn.classList.remove(
              "text-rose-400",
              "bg-rose-500/20",
              "border-rose-500/30",
            );
            btn.classList.add(
              "text-green-400",
              "bg-green-500/20",
              "border-green-500/30",
            );
            // Auto-trigger a new lap after successful lactate submission
            try {
              await fetch("/api/lap", { method: "POST" });
            } catch (lapErr) {
              console.warn("Auto-lap after lactate failed:", lapErr);
            }
          } else {
            throw new Error(result.message || "Failed");
          }
        } catch (err) {
          console.error("Failed to submit lactate:", err);
          btn.innerHTML = '<i data-lucide="x" class="w-5 h-5"></i>';
          btn.classList.remove(
            "text-rose-400",
            "bg-rose-500/20",
            "border-rose-500/30",
          );
          btn.classList.add(
            "text-red-400",
            "bg-red-500/20",
            "border-red-500/30",
          );
          lucide.createIcons({ nodes: btn.querySelectorAll("[data-lucide]") });
        }

        setTimeout(() => {
          btn.disabled = false;
          btn.innerHTML = originalHTML;
          btn.classList.remove(
            "text-green-400",
            "bg-green-500/20",
            "border-green-500/30",
            "text-red-400",
            "bg-red-500/20",
            "border-red-500/30",
          );
          btn.classList.add(
            "text-rose-400",
            "bg-rose-500/20",
            "border-rose-500/30",
          );
          lucide.createIcons({ nodes: btn.querySelectorAll("[data-lucide]") });
        }, 2000);
      }

      // Allow Enter key to set trainer power
      document
        .getElementById("trainerPowerInput")
        .addEventListener("keydown", (e) => {
          if (e.key === "Enter") trainerSetPower();
        });

      // ─── Trainer Control Functions ─────────────────────────
      let _currentTrainerTarget = null;

      async function trainerScan() {
        const btn = document.getElementById("trainerScanBtn");
        btn.disabled = true;
        btn.innerHTML =
          '<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> Scanning...';
        lucide.createIcons({ nodes: btn.querySelectorAll("[data-lucide]") });

        try {
          await fetch("/api/trainer/scan", { method: "POST" });
          // Poll for scan results — the WebSocket will provide real-time updates
          // but also poll the status endpoint for device list
          setTimeout(pollTrainerDevices, 1500);
          setTimeout(pollTrainerDevices, 4000);
          setTimeout(pollTrainerDevices, 8000);
          setTimeout(pollTrainerDevices, 12000);
        } catch (err) {
          console.error("Trainer scan error:", err);
        }

        setTimeout(() => {
          btn.disabled = false;
          btn.innerHTML =
            '<i data-lucide="bluetooth-searching" class="w-4 h-4"></i> Scan for Trainer';
          lucide.createIcons({ nodes: btn.querySelectorAll("[data-lucide]") });
        }, 15000);
      }

      async function pollTrainerDevices() {
        try {
          const resp = await fetch("/api/trainer/status");
          const data = await resp.json();
          const listEl = document.getElementById("trainerDeviceList");

          if (data.scannedDevices && data.scannedDevices.length > 0) {
            listEl.classList.remove("hidden");
            listEl.innerHTML = data.scannedDevices
              .map(
                (
                  d,
                ) => `<button onclick="trainerConnect('${d.address}')" class="w-full px-3 py-2 text-left text-sm rounded-lg bg-neutral-800/80 border border-neutral-700 hover:bg-amber-500/10 hover:border-amber-500/30 transition-colors flex items-center justify-between">
                <span class="text-neutral-300">${d.name}</span>
                <span class="text-[10px] text-neutral-500 font-mono">${d.rssi} dBm</span>
              </button>`,
              )
              .join("");
          }
        } catch (err) {
          console.error("Trainer poll error:", err);
        }
      }

      async function trainerConnect(address) {
        try {
          await fetch("/api/trainer/connect", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ address }),
          });
        } catch (err) {
          console.error("Trainer connect error:", err);
        }
      }

      async function trainerSetPower() {
        const input = document.getElementById("trainerPowerInput");
        const watts = parseInt(input.value);
        if (isNaN(watts) || watts < 0 || watts > 2000) {
          input.classList.add("border-red-500");
          setTimeout(() => input.classList.remove("border-red-500"), 1500);
          return;
        }
        try {
          const resp = await fetch("/api/trainer/power", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ watts }),
          });
          const result = await resp.json();
          if (result.success) {
            _currentTrainerTarget = watts;
            input.value = "";
          }
        } catch (err) {
          console.error("Trainer set power error:", err);
        }
      }

      function trainerQuickPower(watts) {
        fetch("/api/trainer/power", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ watts }),
        })
          .then((r) => r.json())
          .then((result) => {
            if (result.success) _currentTrainerTarget = watts;
          })
          .catch((err) => console.error("Quick power error:", err));
      }

      function trainerAdjustPower(delta) {
        const current = _currentTrainerTarget || 0;
        const newTarget = Math.max(0, Math.min(2000, current + delta));
        fetch("/api/trainer/power", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ watts: newTarget }),
        })
          .then((r) => r.json())
          .then((result) => {
            if (result.success) _currentTrainerTarget = newTarget;
          })
          .catch((err) => console.error("Adjust power error:", err));
      }

      async function trainerDisconnect() {
        try {
          await fetch("/api/trainer/disconnect", { method: "POST" });
          _currentTrainerTarget = null;
        } catch (err) {
          console.error("Trainer disconnect error:", err);
        }
      }
    </script>
  </body>
</html>
