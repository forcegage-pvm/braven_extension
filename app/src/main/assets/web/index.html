<!doctype html>
<html lang="en" class="h-full bg-neutral-950 antialiased">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Braven Lab Dashboard</title>
    <script src="/js/tailwind.js"></script>
    <script src="/js/lucide.min.js"></script>
    <style>
      @font-face {
        font-family: "Inter";
        font-style: normal;
        font-weight: 300;
        src: url("/fonts/inter-300.ttf") format("truetype");
      }
      @font-face {
        font-family: "Inter";
        font-style: normal;
        font-weight: 400;
        src: url("/fonts/inter-400.ttf") format("truetype");
      }
      @font-face {
        font-family: "Inter";
        font-style: normal;
        font-weight: 500;
        src: url("/fonts/inter-500.ttf") format("truetype");
      }
      @font-face {
        font-family: "Inter";
        font-style: normal;
        font-weight: 600;
        src: url("/fonts/inter-600.ttf") format("truetype");
      }
      @font-face {
        font-family: "Inter";
        font-style: normal;
        font-weight: 700;
        src: url("/fonts/inter-600.ttf") format("truetype");
      }
      .no-scrollbar::-webkit-scrollbar {
        display: none;
      }
      .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }

      /* ═══ Responsive Grid Layout ═══ */
      .dashboard-grid {
        grid-template-columns: 3fr 3fr 2fr 2fr;
        grid-template-rows: 3fr 3fr 2fr 1.5fr;
      }

      /* Tablet landscape (≤1199px) — fits iPad Mini through iPad Pro 11" */
      @media (max-width: 1199px) {
        .dashboard-grid {
          grid-template-columns: 1fr 1fr 1fr 1fr;
          grid-template-rows: 2fr 2fr 1fr 0.8fr;
          gap: 0.2rem;
          padding: 0.2rem;
        }
        .dashboard-grid > * {
          min-height: 0;
          min-width: 0;
          overflow: hidden;
        }
        .dashboard-grid [class*="min-h-"] {
          min-height: 0 !important;
        }
        .time-strip {
          padding: 0.15rem 0.5rem;
        }
        .time-strip .timer-value {
          font-size: 1rem;
        }
        .time-strip .timer-label {
          font-size: 0.55rem;
        }
      }

      /* Tablet portrait (~600–767px) — 2-column grid, cards reflow */
      @media (max-width: 767px) {
        .dashboard-grid {
          grid-template-columns: 1fr 1fr;
          grid-template-rows: auto;
          overflow-y: auto;
        }
        /* Reset explicit grid positions for 2-col reflow */
        .dashboard-grid > * {
          grid-column: auto !important;
          grid-row: auto !important;
        }
        .dashboard-grid .power-card {
          grid-column: 1 / -1 !important;
        }
        .dashboard-grid .lap-card {
          grid-column: 1 / -1 !important;
        }
        .dashboard-grid .trainer-card {
          grid-column: 1 / -1 !important;
        }
        .dashboard-grid .lactate-card {
          grid-column: 1 / -1 !important;
        }
        .dashboard-grid .ride-info-card {
          display: none;
        }
        .time-strip {
          flex-direction: column;
          gap: 0.25rem;
          padding: 0.5rem;
        }
        .time-strip .timer-group {
          gap: 0.5rem;
        }
        .time-strip .timer-value {
          font-size: 1.25rem;
        }
        .time-strip .divider {
          display: none;
        }
      }

      /* Small phone (<600px) — single column */
      @media (max-width: 599px) {
        .dashboard-grid {
          grid-template-columns: 1fr;
        }
        .dashboard-grid > * {
          grid-column: auto !important;
          grid-row: auto !important;
        }
      }

      /* Desktop (1200px+) — restore comfortable spacing */
      @media (min-width: 1200px) {
        .dashboard-grid {
          gap: 0.75rem;
          padding: 0.75rem;
        }
        .dashboard-grid .power-card {
          padding: 1rem 1.25rem;
        }
        .dashboard-grid .lap-card {
          padding: 0.75rem 1rem;
        }
        .dashboard-grid .row-start-3 {
          padding: 0.75rem;
        }
        .dashboard-grid .row-start-4 {
          padding: 0.5rem 0.75rem;
        }
        .dashboard-grid .trainer-card {
          padding: 0.5rem 0.75rem;
        }
        .dashboard-grid .lactate-card {
          padding: 0.5rem 0.75rem;
        }
        .dashboard-grid .ride-info-card {
          padding: 0.5rem 0.75rem;
        }
        .time-strip {
          padding: 0.5rem 1.5rem;
        }
        .metric-value-xl {
          font-size: clamp(3rem, 5vw, 6rem);
        }
        .metric-value-lg {
          font-size: clamp(2.5rem, 4vw, 4.5rem);
        }
      }
      /* Font scaling — Tablet (768–1199px): much smaller */
      @media (max-width: 1199px) and (min-width: 768px) {
        .metric-value-xl {
          font-size: clamp(1.5rem, 3vw, 2.5rem);
        }
        .metric-value-lg {
          font-size: clamp(1.125rem, 2.5vw, 1.75rem);
        }
        /* Scale down inline metric text too */
        .dashboard-grid .text-3xl {
          font-size: 1.25rem;
        }
        .dashboard-grid .text-4xl {
          font-size: 1.5rem;
        }
        .dashboard-grid .text-5xl {
          font-size: 1.75rem;
        }
        .dashboard-grid .text-6xl {
          font-size: 2rem;
        }
        .dashboard-grid .text-7xl {
          font-size: 2.25rem;
        }
        .dashboard-grid .text-8xl {
          font-size: 2.5rem;
        }
        .dashboard-grid .text-2xl {
          font-size: 1.125rem;
        }
        .dashboard-grid .text-xl {
          font-size: 1rem;
        }
        .dashboard-grid .text-lg {
          font-size: 0.875rem;
        }
      }
    </style>
    <script>
      tailwind.config = {
        theme: {
          fontFamily: {
            sans: ["Inter", "sans-serif"],
            mono: [
              "ui-monospace",
              "SFMono-Regular",
              "Menlo",
              "Monaco",
              "Consolas",
              "monospace",
            ],
          },
          extend: {
            colors: {
              karoo: { yellow: "#FFD700", purple: "#8B5CF6" },
            },
            keyframes: {
              pulsefast: {
                "0%, 100%": { opacity: "1" },
                "50%": { opacity: "0.4" },
              },
            },
            animation: {
              pulsefast: "pulsefast 2s cubic-bezier(0.4, 0, 0.6, 1) infinite",
            },
          },
        },
      };
    </script>
  </head>
  <body
    class="h-full flex flex-col text-neutral-100 overflow-hidden selection:bg-karoo-yellow selection:text-black"
  >
    <!-- Hidden refs for compact stats (removed from UI) -->
    <div class="hidden">
      <span id="elapsedTime">00:00:00</span>
      <span id="lapNumber">1</span>
      <span id="lapTime">00:00</span>
      <i id="batteryIcon" data-lucide="battery"></i>
      <span id="batteryPercent">--%</span>
    </div>

    <!-- ═══════════════ TIME STRIP - Session & Lap Timers ═══════════════ -->
    <div
      class="time-strip flex-none flex items-center justify-between px-4 py-1 bg-neutral-900/50 border-b border-white/5"
    >
      <!-- Left: Connection Badge + Title + Update time -->
      <div class="flex items-center gap-4">
        <div
          id="connectionBadge"
          class="flex items-center gap-2 px-3 py-1 rounded-full bg-red-500/10 border border-red-500/20"
        >
          <span class="relative flex h-2 w-2">
            <span
              id="pingDot"
              class="absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"
            ></span>
            <span
              id="solidDot"
              class="relative inline-flex rounded-full h-2 w-2 bg-red-500"
            ></span>
          </span>
          <span
            id="connectionText"
            class="text-xs font-medium text-red-500 tracking-wide uppercase"
            >Disconnected</span
          >
        </div>
        <!-- Ride State Badge -->
        <div
          id="rideStateBadge"
          class="flex items-center gap-1.5 px-2.5 py-0.5 rounded-full bg-neutral-500/10 border border-neutral-500/20"
        >
          <span id="rideStateIcon" class="text-neutral-500">
            <i data-lucide="circle-pause" class="w-3 h-3"></i>
          </span>
          <span
            id="rideStateText"
            class="text-[10px] font-medium text-neutral-500 tracking-wide uppercase"
            >Idle</span
          >
        </div>
        <h1
          class="text-base font-medium text-neutral-500 tracking-tight hidden sm:block"
        >
          Braven Performance Lab
        </h1>
        <span class="hidden sm:inline-block h-4 w-px bg-white/10"></span>
        <span
          id="lastUpdate"
          class="hidden sm:block text-[10px] text-neutral-600 uppercase tracking-widest font-medium"
          >--</span
        >
      </div>

      <!-- Timers -->
      <div class="timer-group flex items-center gap-6 md:gap-12">
        <div class="flex items-center gap-2 md:gap-3">
          <div class="flex items-center gap-1 md:gap-2 text-neutral-500">
            <i data-lucide="timer" class="w-4 h-4 md:w-5 md:h-5"></i>
            <span
              class="timer-label text-xs md:text-sm font-medium uppercase tracking-wide"
              >Session</span
            >
          </div>
          <span
            id="sessionTime"
            class="timer-value text-xl md:text-3xl font-bold tabular-nums text-white tracking-tight"
            >00:00:00</span
          >
        </div>

        <!-- Divider -->
        <div class="divider h-8 w-px bg-white/10"></div>

        <!-- Lap Time -->
        <div class="flex items-center gap-2 md:gap-3">
          <div class="flex items-center gap-1 md:gap-2 text-neutral-500">
            <i data-lucide="flag" class="w-4 h-4 md:w-5 md:h-5"></i>
            <span
              class="timer-label text-xs md:text-sm font-medium uppercase tracking-wide"
              >Lap <span id="lapNumberBig" class="text-amber-400">1</span></span
            >
          </div>
          <span
            id="lapTimeBig"
            class="timer-value text-xl md:text-3xl font-bold tabular-nums text-amber-400 tracking-tight"
            >00:00</span
          >
        </div>
      </div>
    </div>

    <!-- Main Dashboard - Primary Metrics Focus -->
    <main
      class="dashboard-grid flex-grow p-2 grid gap-2 relative overflow-hidden"
    >
      <!-- Background glow -->
      <div
        class="absolute top-1/3 left-1/4 w-[600px] h-[600px] bg-purple-900/20 rounded-full blur-[150px] pointer-events-none"
      ></div>
      <div
        class="absolute bottom-1/3 right-1/4 w-[400px] h-[400px] bg-rose-900/15 rounded-full blur-[120px] pointer-events-none"
      ></div>

      <!-- ═══════════════ POWER - Primary Metric (2 columns) ═══════════════ -->
      <div
        class="power-card col-span-2 row-span-2 relative flex flex-col rounded-xl bg-gradient-to-br from-purple-950/40 to-neutral-900/60 border border-purple-500/20 border-l-2 border-l-purple-500 p-2 backdrop-blur-sm overflow-hidden"
      >
        <div class="flex items-center justify-between">
          <span
            class="text-[10px] font-semibold tracking-widest text-purple-400 uppercase"
            >Power</span
          >
          <span
            id="powerZoneBadge"
            class="text-[10px] font-bold text-purple-300 bg-purple-500/20 px-2 py-0.5 rounded"
            >--</span
          >
        </div>
        <div class="flex items-end gap-4 my-1">
          <div class="flex-1">
            <div class="text-[10px] text-neutral-500 uppercase tracking-wider">
              Instant
            </div>
            <div class="flex items-baseline gap-1">
              <span
                id="power"
                class="metric-value-xl text-7xl md:text-8xl font-bold tracking-tighter text-white tabular-nums leading-none"
                >--</span
              >
              <span class="text-lg text-neutral-500 font-medium">W</span>
            </div>
          </div>
          <div class="flex-1">
            <div class="text-[10px] text-neutral-500 uppercase tracking-wider">
              3s Avg
            </div>
            <div class="flex items-baseline gap-1">
              <span
                id="power3sAvg"
                class="metric-value-lg text-5xl md:text-7xl font-bold tracking-tighter text-purple-300 tabular-nums leading-none"
                >--</span
              >
              <span class="text-base text-neutral-500 font-medium">W</span>
            </div>
          </div>
        </div>
        <div class="flex gap-4 text-xs text-neutral-500 mb-1">
          <div>
            Avg:
            <span id="lapPower" class="text-white font-semibold tabular-nums"
              >-- W</span
            >
          </div>
          <div>
            NP:
            <span
              id="lapNormalizedPower"
              class="text-white font-semibold tabular-nums"
              >-- W</span
            >
          </div>
          <div>
            Max:
            <span id="lapMaxPower" class="text-white font-semibold tabular-nums"
              >-- W</span
            >
          </div>
        </div>
        <div class="flex-grow relative min-h-[80px]">
          <canvas id="powerGraph" class="w-full h-full"></canvas>
          <div
            class="absolute bottom-0 left-0 right-0 h-6 bg-gradient-to-t from-purple-950/60 to-transparent pointer-events-none"
          ></div>
        </div>
      </div>

      <!-- ═══════════════ VO2 (1 column) ═══════════════ -->
      <div
        class="row-start-3 relative flex flex-col rounded-xl bg-gradient-to-br from-cyan-950/40 to-neutral-900/60 border border-cyan-500/20 border-l-2 border-l-cyan-500 p-2 backdrop-blur-sm overflow-hidden"
      >
        <div class="flex items-center justify-between">
          <span
            class="text-[10px] font-semibold tracking-widest text-cyan-400 uppercase"
            >VO2</span
          >
          <span
            id="vo2LiveBadge"
            class="text-[10px] font-medium text-neutral-500"
            >Pending</span
          >
        </div>
        <div class="flex items-baseline gap-1">
          <span
            id="vo2"
            class="metric-value-lg text-4xl md:text-5xl font-bold tracking-tighter text-white tabular-nums"
            >--</span
          >
          <span class="text-sm text-neutral-500">ml/kg/min</span>
        </div>
        <div class="flex-grow relative min-h-[60px] mt-0.5">
          <canvas id="vo2Graph" class="w-full h-full"></canvas>
        </div>
        <div class="text-[10px] text-neutral-500 mt-auto pt-1">
          % Max:
          <span id="vo2Percent" class="text-cyan-400 font-semibold">--%</span>
        </div>
      </div>

      <!-- ═══════════════ HEART RATE (1 column) ═══════════════ -->
      <div
        class="row-start-3 relative flex flex-col rounded-xl bg-gradient-to-br from-rose-950/40 to-neutral-900/60 border border-rose-500/20 border-l-2 border-l-rose-500 p-2 backdrop-blur-sm overflow-hidden"
      >
        <div class="flex items-center justify-between">
          <span
            class="text-[10px] font-semibold tracking-widest text-rose-400 uppercase"
            >Heart Rate</span
          >
          <span
            id="hrLiveBadge"
            class="text-[10px] font-medium text-rose-400 animate-pulsefast"
            >Live</span
          >
        </div>
        <div class="flex items-baseline gap-1">
          <span
            id="heartRate"
            class="metric-value-lg text-4xl md:text-5xl font-bold tracking-tighter text-white tabular-nums"
            >--</span
          >
          <span class="text-sm text-neutral-500">BPM</span>
        </div>
        <div class="flex-grow relative min-h-[60px] mt-0.5">
          <canvas id="hrGraph" class="w-full h-full"></canvas>
        </div>
        <div class="flex gap-3 text-[10px] text-neutral-500 mt-auto pt-1">
          <div>
            Max:
            <span id="maxHeartRate" class="text-white font-semibold">--</span>
          </div>
          <div>
            Lap:
            <span id="lapHeartRate" class="text-white font-semibold">--</span>
          </div>
        </div>
      </div>

      <!-- ═══════════════ CADENCE (1 column) ═══════════════ -->
      <div
        class="row-start-4 relative flex flex-col rounded-xl bg-gradient-to-br from-blue-950/40 to-neutral-900/60 border border-blue-500/20 border-l-2 border-l-blue-400 p-1.5 backdrop-blur-sm overflow-hidden"
      >
        <span
          class="text-[10px] font-semibold tracking-widest text-blue-400 uppercase"
          >Cadence</span
        >
        <div class="flex items-baseline gap-1">
          <span
            id="cadence"
            class="text-2xl md:text-3xl font-bold tracking-tighter text-white tabular-nums"
            >--</span
          >
          <span class="text-sm text-neutral-500">RPM</span>
        </div>
        <div class="flex gap-3 text-[10px] text-neutral-500 mt-auto">
          <div>
            Avg:
            <span id="avgCadence" class="text-white font-semibold">--</span>
          </div>
          <div>
            Lap:
            <span id="lapCadence" class="text-white font-semibold">--</span>
          </div>
        </div>
        <div class="hidden">
          <canvas id="cadenceGraph" class="w-full h-full"></canvas>
        </div>
      </div>

      <!-- ═══════════════ SPEED (1 column) ═══════════════ -->
      <div
        class="row-start-4 relative flex flex-col rounded-xl bg-gradient-to-br from-emerald-950/30 to-neutral-900/60 border border-emerald-500/10 border-l-2 border-l-emerald-500 p-1.5 backdrop-blur-sm overflow-hidden"
      >
        <span
          class="text-[10px] font-medium tracking-widest text-emerald-400/70 uppercase"
          >Speed</span
        >
        <div class="flex items-baseline gap-1">
          <span
            id="speed"
            class="text-2xl md:text-3xl font-bold tracking-tighter text-white tabular-nums"
            >--</span
          >
          <span class="text-sm text-neutral-500">KPH</span>
        </div>
        <div class="flex gap-3 text-[10px] text-neutral-500 mt-auto">
          <div>Avg: <span id="averageSpeed" class="text-white">--</span></div>
          <div>Lap: <span id="lapSpeed" class="text-white">--</span></div>
        </div>
      </div>

      <!-- ═══════════════ LAP HISTORY & CAPTURE ROW ═══════════════ -->

      <!-- Lap History Table (full width) -->
      <div
        class="lap-card col-span-2 row-span-2 col-start-3 row-start-1 relative flex flex-col rounded-xl bg-neutral-900/30 border border-white/5 p-2 backdrop-blur-sm"
      >
        <div class="flex items-center justify-between mb-1">
          <span
            class="text-[10px] font-medium tracking-wider text-neutral-500 uppercase"
            >Lap History</span
          >
          <button
            id="newLapBtn"
            onclick="markNewLap()"
            class="flex items-center gap-1 px-2 py-1 text-[10px] font-semibold uppercase tracking-wide rounded bg-amber-500/20 text-amber-400 border border-amber-500/30 hover:bg-amber-500/30 hover:border-amber-500/50 transition-colors"
          >
            <i data-lucide="flag" class="w-3 h-3"></i> New Lap
          </button>
        </div>
        <div
          class="overflow-auto flex-1 scrollbar-thin scrollbar-thumb-neutral-700"
        >
          <table class="w-full text-xs">
            <thead
              class="sticky top-0 bg-neutral-900/90 text-neutral-400 text-[10px] uppercase"
            >
              <tr class="border-b border-neutral-700">
                <th class="px-2 py-1 text-left">Lap</th>
                <th class="px-2 py-1 text-left">Time</th>
                <th class="px-2 py-1 text-left">Power</th>
                <th class="px-2 py-1 text-left">HR</th>
                <th class="px-2 py-1 text-left">Cad</th>
                <th class="px-2 py-1 text-left">La</th>
              </tr>
            </thead>
            <tbody>
              <tr
                id="currentLapRow"
                class="border-b border-cyan-900/50 bg-cyan-950/30"
              >
                <td class="px-2 py-1 text-cyan-400 font-semibold">1</td>
                <td class="px-2 py-1 font-mono text-cyan-300">00:00</td>
                <td class="px-2 py-1 font-semibold text-cyan-400">--</td>
                <td class="px-2 py-1 text-cyan-300">--</td>
                <td class="px-2 py-1 text-cyan-300">--</td>
                <td class="px-2 py-1 text-cyan-300">--</td>
              </tr>
            </tbody>
            <!-- Completed laps (populated dynamically) -->
            <tbody id="lapListBody" class="text-neutral-300"></tbody>
          </table>
        </div>
      </div>

      <!-- Trainer Control (KICKR via BLE FTMS) -->
      <div
        class="trainer-card col-span-2 col-start-3 row-start-4 relative flex flex-col rounded-xl bg-neutral-900/30 border border-white/5 p-1.5 backdrop-blur-sm"
      >
        <div class="flex items-center justify-between mb-1">
          <span
            class="text-[10px] font-medium tracking-wider text-neutral-500 uppercase"
            >Trainer Control</span
          >
          <span
            id="trainerStateBadge"
            class="px-2 py-0.5 text-[10px] font-bold uppercase tracking-widest rounded-full bg-neutral-700/50 text-neutral-500"
            >Disconnected</span
          >
        </div>

        <!-- Scan / Device List / Connection -->
        <div id="trainerScanSection">
          <button
            id="trainerScanBtn"
            onclick="trainerScan()"
            class="w-full px-3 py-2 text-xs font-semibold uppercase tracking-wide rounded-lg bg-amber-500/20 text-amber-400 border border-amber-500/30 hover:bg-amber-500/30 hover:border-amber-500/50 transition-colors flex items-center justify-center gap-2"
          >
            <i data-lucide="bluetooth-searching" class="w-4 h-4"></i>
            Scan for Trainer
          </button>
          <div
            id="trainerDeviceList"
            class="mt-2 space-y-1 max-h-32 overflow-y-auto hidden"
          ></div>
        </div>

        <!-- Connected: ERG Target -->
        <div id="trainerControlSection" class="hidden">
          <div class="flex items-baseline gap-1 mb-2">
            <span
              id="trainerDeviceName"
              class="text-sm font-medium text-neutral-400 truncate"
              >--</span
            >
          </div>
          <div class="flex items-baseline gap-1 mb-3">
            <span
              id="trainerTargetDisplay"
              class="text-4xl font-bold tracking-tighter text-amber-400 tabular-nums"
              >--</span
            >
            <span class="text-sm text-neutral-500">W</span>
          </div>
          <div class="flex gap-2 mb-2">
            <input
              id="trainerPowerInput"
              type="number"
              step="5"
              min="0"
              max="2000"
              placeholder="e.g. 200"
              class="flex-1 px-3 py-1.5 rounded-lg bg-neutral-800/80 border border-neutral-700 text-white text-sm font-mono placeholder:text-neutral-600 focus:outline-none focus:border-amber-500/50 focus:ring-1 focus:ring-amber-500/20"
            />
            <button
              id="trainerSetPowerBtn"
              onclick="trainerSetPower()"
              class="px-3 py-1.5 text-xs font-semibold uppercase tracking-wide rounded-lg bg-amber-500/20 text-amber-400 border border-amber-500/30 hover:bg-amber-500/30 hover:border-amber-500/50 transition-colors"
            >
              Set
            </button>
          </div>
          <!-- Quick-set power buttons -->
          <div class="grid grid-cols-5 gap-1 mb-2">
            <button
              onclick="trainerQuickPower(100)"
              class="px-1 py-1 text-[10px] font-mono rounded bg-neutral-800/80 text-neutral-400 hover:bg-amber-500/20 hover:text-amber-400 transition-colors"
            >
              100
            </button>
            <button
              onclick="trainerQuickPower(150)"
              class="px-1 py-1 text-[10px] font-mono rounded bg-neutral-800/80 text-neutral-400 hover:bg-amber-500/20 hover:text-amber-400 transition-colors"
            >
              150
            </button>
            <button
              onclick="trainerQuickPower(200)"
              class="px-1 py-1 text-[10px] font-mono rounded bg-neutral-800/80 text-neutral-400 hover:bg-amber-500/20 hover:text-amber-400 transition-colors"
            >
              200
            </button>
            <button
              onclick="trainerQuickPower(250)"
              class="px-1 py-1 text-[10px] font-mono rounded bg-neutral-800/80 text-neutral-400 hover:bg-amber-500/20 hover:text-amber-400 transition-colors"
            >
              250
            </button>
            <button
              onclick="trainerQuickPower(300)"
              class="px-1 py-1 text-[10px] font-mono rounded bg-neutral-800/80 text-neutral-400 hover:bg-amber-500/20 hover:text-amber-400 transition-colors"
            >
              300
            </button>
          </div>
          <!-- +/- increment buttons -->
          <div class="flex gap-2 mb-2">
            <button
              onclick="trainerAdjustPower(-25)"
              class="flex-1 px-2 py-1.5 text-xs font-semibold rounded-lg bg-neutral-800/80 text-neutral-400 hover:bg-red-500/20 hover:text-red-400 border border-neutral-700 hover:border-red-500/30 transition-colors"
            >
              -25 W
            </button>
            <button
              onclick="trainerAdjustPower(-5)"
              class="flex-1 px-2 py-1.5 text-xs font-semibold rounded-lg bg-neutral-800/80 text-neutral-400 hover:bg-red-500/20 hover:text-red-400 border border-neutral-700 hover:border-red-500/30 transition-colors"
            >
              -5 W
            </button>
            <button
              onclick="trainerAdjustPower(5)"
              class="flex-1 px-2 py-1.5 text-xs font-semibold rounded-lg bg-neutral-800/80 text-neutral-400 hover:bg-green-500/20 hover:text-green-400 border border-neutral-700 hover:border-green-500/30 transition-colors"
            >
              +5 W
            </button>
            <button
              onclick="trainerAdjustPower(25)"
              class="flex-1 px-2 py-1.5 text-xs font-semibold rounded-lg bg-neutral-800/80 text-neutral-400 hover:bg-green-500/20 hover:text-green-400 border border-neutral-700 hover:border-green-500/30 transition-colors"
            >
              +25 W
            </button>
          </div>
          <button
            onclick="trainerDisconnect()"
            class="w-full px-3 py-1.5 text-xs font-semibold uppercase tracking-wide rounded-lg bg-neutral-800/50 text-neutral-500 border border-neutral-700 hover:bg-red-500/10 hover:text-red-400 hover:border-red-500/30 transition-colors"
          >
            Disconnect
          </button>
        </div>

        <div id="trainerError" class="text-xs text-red-400 mt-2 hidden"></div>
      </div>

      <!-- Lactate Entry -->
      <div
        class="lactate-card row-start-3 col-start-3 relative flex rounded-xl bg-neutral-900/30 border border-white/5 border-l-2 border-l-rose-500 p-1.5 backdrop-blur-sm gap-1.5"
      >
        <div class="flex flex-col justify-between flex-1 min-w-0">
          <span
            class="text-[10px] font-medium tracking-wider text-rose-400 uppercase"
            >Lactate</span
          >
          <div class="flex items-baseline gap-1">
            <span
              id="lactateValue"
              class="text-2xl md:text-3xl font-bold tracking-tighter text-white tabular-nums"
              >--</span
            >
            <span class="text-[10px] text-neutral-500">mmol/L</span>
          </div>
          <div id="lactateTimestamp" class="text-[10px] text-neutral-500"></div>
          <div class="flex items-center gap-1 mt-0.5">
            <span class="text-[10px] text-neutral-600">Delay:</span>
            <select
              id="lactateDelay"
              class="text-[10px] bg-neutral-800/80 border border-neutral-700 text-neutral-300 rounded px-1 py-0.5 focus:outline-none focus:border-rose-500/50"
            >
              <option value="0">0s</option>
              <option value="15">15s</option>
              <option value="30" selected>30s</option>
              <option value="45">45s</option>
              <option value="60">60s</option>
              <option value="90">90s</option>
            </select>
          </div>
        </div>
        <!-- Right column: stepper controls -->
        <div class="flex items-center justify-center gap-1 shrink-0">
          <!-- Whole digit -->
          <div class="flex flex-col items-center gap-0.5">
            <button
              onclick="lactateStep('whole', 1)"
              class="w-9 h-6 flex items-center justify-center rounded-md bg-neutral-800/80 border border-neutral-700 text-neutral-400 hover:bg-neutral-700/80 hover:text-white transition-colors"
            >
              <i data-lucide="chevron-up" class="w-3.5 h-3.5"></i>
            </button>
            <div
              id="lactateWhole"
              class="w-9 h-9 flex items-center justify-center rounded-md bg-neutral-800/80 border border-neutral-700 text-white text-base font-bold font-mono"
            >
              0
            </div>
            <button
              onclick="lactateStep('whole', -1)"
              class="w-9 h-6 flex items-center justify-center rounded-md bg-neutral-800/80 border border-neutral-700 text-neutral-400 hover:bg-neutral-700/80 hover:text-white transition-colors"
            >
              <i data-lucide="chevron-down" class="w-3.5 h-3.5"></i>
            </button>
          </div>
          <!-- Dot -->
          <span class="text-base font-bold text-neutral-500 self-center"
            >.</span
          >
          <!-- Decimal digit -->
          <div class="flex flex-col items-center gap-0.5">
            <button
              onclick="lactateStep('dec', 1)"
              class="w-9 h-6 flex items-center justify-center rounded-md bg-neutral-800/80 border border-neutral-700 text-neutral-400 hover:bg-neutral-700/80 hover:text-white transition-colors"
            >
              <i data-lucide="chevron-up" class="w-3.5 h-3.5"></i>
            </button>
            <div
              id="lactateDec"
              class="w-9 h-9 flex items-center justify-center rounded-md bg-neutral-800/80 border border-neutral-700 text-white text-base font-bold font-mono"
            >
              0
            </div>
            <button
              onclick="lactateStep('dec', -1)"
              class="w-9 h-6 flex items-center justify-center rounded-md bg-neutral-800/80 border border-neutral-700 text-neutral-400 hover:bg-neutral-700/80 hover:text-white transition-colors"
            >
              <i data-lucide="chevron-down" class="w-3.5 h-3.5"></i>
            </button>
          </div>
          <!-- Submit -->
          <button
            id="lactateSubmitBtn"
            onclick="submitLactate()"
            class="w-9 h-9 flex items-center justify-center rounded-lg bg-rose-500/20 text-rose-400 border border-rose-500/30 hover:bg-rose-500/30 hover:border-rose-500/50 transition-colors self-center ml-0.5"
          >
            <i data-lucide="check" class="w-4 h-4"></i>
          </button>
        </div>
      </div>

      <!-- Ride Info (compact) — uses freed col4 from lactate -->
      <div
        class="ride-info-card col-start-4 row-start-3 relative flex flex-col rounded-xl bg-neutral-900/30 border border-white/5 p-1.5 backdrop-blur-sm overflow-hidden"
      >
        <span
          class="text-[10px] font-medium tracking-wider text-neutral-500 uppercase mb-0.5"
          >Ride Info</span
        >
        <div class="flex flex-col gap-1 mt-auto">
          <div>
            <div class="text-[10px] text-neutral-600 uppercase tracking-wide">
              Distance
            </div>
            <span
              id="distance"
              class="text-lg font-bold text-white tabular-nums"
              >0.00 km</span
            >
          </div>
          <div>
            <div class="text-[10px] text-neutral-600 uppercase tracking-wide">
              Elevation
            </div>
            <span
              id="elevation"
              class="text-sm font-semibold text-neutral-400 tabular-nums"
              >--</span
            >
            <span class="text-[10px] text-neutral-600">m</span>
          </div>
          <div>
            <div class="text-[10px] text-neutral-600 uppercase tracking-wide">
              Grade
            </div>
            <span
              id="grade"
              class="text-sm font-semibold text-neutral-400 tabular-nums"
              >0.0</span
            >
            <span class="text-[10px] text-neutral-600">%</span>
          </div>
        </div>
      </div>

      <!-- Hidden elements to keep JS refs intact -->
      <span id="temperature" class="hidden"></span>
      <span id="coreTemp" class="hidden"></span>
      <span id="coreTempTrend" class="hidden"></span>
      <span id="latitude" class="hidden"></span>
      <span id="longitude" class="hidden"></span>
    </main>

    <script src="/js/websocket-client.js"></script>
    <script src="/js/dashboard-renderer.js"></script>
    <script>
      // Initialize Lucide icons
      lucide.createIcons();

      // Initialize the dashboard
      const client = new BravenWebSocketClient();
      const renderer = new DashboardRenderer();

      client.onData((data) => {
        renderer.update(data);
      });

      client.onStatusChange((connected) => {
        renderer.setConnectionStatus(connected);
      });

      client.connect();

      // Force reconnect when WiFi comes back or tab regains focus
      window.addEventListener("online", () => {
        console.log("[Dashboard] Network online — forcing reconnect");
        client.forceReconnect();
      });
      document.addEventListener("visibilitychange", () => {
        if (!document.hidden) {
          console.log("[Dashboard] Tab visible — forcing reconnect");
          client.forceReconnect();
        }
      });

      /**
       * Mark a new lap on the Karoo via the API
       */
      async function markNewLap() {
        const btn = document.getElementById("newLapBtn");
        const originalHTML = btn.innerHTML;

        try {
          // Visual feedback
          btn.disabled = true;
          btn.innerHTML =
            '<i data-lucide="loader-2" class="w-3.5 h-3.5 animate-spin"></i> Marking...';
          lucide.createIcons({ nodes: btn.querySelectorAll("[data-lucide]") });

          const response = await fetch("/api/lap", { method: "POST" });
          const result = await response.json();

          if (result.success) {
            btn.innerHTML =
              '<i data-lucide="check" class="w-3.5 h-3.5"></i> Lap Marked!';
            btn.classList.remove(
              "text-amber-400",
              "bg-amber-500/20",
              "border-amber-500/30",
            );
            btn.classList.add(
              "text-green-400",
              "bg-green-500/20",
              "border-green-500/30",
            );
          } else {
            throw new Error(result.message || "Failed to mark lap");
          }
        } catch (err) {
          console.error("Failed to mark lap:", err);
          btn.innerHTML = '<i data-lucide="x" class="w-3.5 h-3.5"></i> Failed';
          btn.classList.remove(
            "text-amber-400",
            "bg-amber-500/20",
            "border-amber-500/30",
          );
          btn.classList.add(
            "text-red-400",
            "bg-red-500/20",
            "border-red-500/30",
          );
        }

        lucide.createIcons({ nodes: btn.querySelectorAll("[data-lucide]") });

        // Reset button after delay
        setTimeout(() => {
          btn.disabled = false;
          btn.innerHTML = originalHTML;
          btn.classList.remove(
            "text-green-400",
            "bg-green-500/20",
            "border-green-500/30",
            "text-red-400",
            "bg-red-500/20",
            "border-red-500/30",
          );
          btn.classList.add(
            "text-amber-400",
            "bg-amber-500/20",
            "border-amber-500/30",
          );
          lucide.createIcons({ nodes: btn.querySelectorAll("[data-lucide]") });
        }, 2000);
      }

      /**
       * Lactate stepper state
       */
      let _lactateWhole = 0;
      let _lactateDec = 0;

      function lactateStep(part, delta) {
        if (part === "whole") {
          _lactateWhole = Math.max(0, Math.min(50, _lactateWhole + delta));
          document.getElementById("lactateWhole").textContent = _lactateWhole;
        } else {
          _lactateDec = (((_lactateDec + delta) % 10) + 10) % 10;
          document.getElementById("lactateDec").textContent = _lactateDec;
        }
      }

      /**
       * Submit a lactate measurement via the API
       */
      async function submitLactate() {
        const btn = document.getElementById("lactateSubmitBtn");
        const value = _lactateWhole + _lactateDec * 0.1;

        if (value < 0 || value > 50) return;

        const originalHTML = btn.innerHTML;
        try {
          btn.disabled = true;
          btn.innerHTML =
            '<i data-lucide="loader-2" class="w-5 h-5 animate-spin"></i>';
          lucide.createIcons({ nodes: btn.querySelectorAll("[data-lucide]") });

          const response = await fetch("/api/lactate", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              value: value,
              offsetSeconds:
                parseInt(document.getElementById("lactateDelay").value) || 0,
            }),
          });
          const result = await response.json();

          if (result.success) {
            btn.classList.remove(
              "text-rose-400",
              "bg-rose-500/20",
              "border-rose-500/30",
            );
            btn.classList.add(
              "text-green-400",
              "bg-green-500/20",
              "border-green-500/30",
            );
            // Auto-trigger a new lap after successful lactate submission
            try {
              await fetch("/api/lap", { method: "POST" });
            } catch (lapErr) {
              console.warn("Auto-lap after lactate failed:", lapErr);
            }
          } else {
            throw new Error(result.message || "Failed");
          }
        } catch (err) {
          console.error("Failed to submit lactate:", err);
          btn.innerHTML = '<i data-lucide="x" class="w-5 h-5"></i>';
          btn.classList.remove(
            "text-rose-400",
            "bg-rose-500/20",
            "border-rose-500/30",
          );
          btn.classList.add(
            "text-red-400",
            "bg-red-500/20",
            "border-red-500/30",
          );
          lucide.createIcons({ nodes: btn.querySelectorAll("[data-lucide]") });
        }

        setTimeout(() => {
          btn.disabled = false;
          btn.innerHTML = originalHTML;
          btn.classList.remove(
            "text-green-400",
            "bg-green-500/20",
            "border-green-500/30",
            "text-red-400",
            "bg-red-500/20",
            "border-red-500/30",
          );
          btn.classList.add(
            "text-rose-400",
            "bg-rose-500/20",
            "border-rose-500/30",
          );
          lucide.createIcons({ nodes: btn.querySelectorAll("[data-lucide]") });
        }, 2000);
      }

      // Allow Enter key to set trainer power
      document
        .getElementById("trainerPowerInput")
        .addEventListener("keydown", (e) => {
          if (e.key === "Enter") trainerSetPower();
        });

      // ─── Trainer Control Functions ─────────────────────────
      let _currentTrainerTarget = null;

      async function trainerScan() {
        const btn = document.getElementById("trainerScanBtn");
        btn.disabled = true;
        btn.innerHTML =
          '<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> Scanning...';
        lucide.createIcons({ nodes: btn.querySelectorAll("[data-lucide]") });

        try {
          await fetch("/api/trainer/scan", { method: "POST" });
          // Poll for scan results — the WebSocket will provide real-time updates
          // but also poll the status endpoint for device list
          setTimeout(pollTrainerDevices, 1500);
          setTimeout(pollTrainerDevices, 4000);
          setTimeout(pollTrainerDevices, 8000);
          setTimeout(pollTrainerDevices, 12000);
        } catch (err) {
          console.error("Trainer scan error:", err);
        }

        setTimeout(() => {
          btn.disabled = false;
          btn.innerHTML =
            '<i data-lucide="bluetooth-searching" class="w-4 h-4"></i> Scan for Trainer';
          lucide.createIcons({ nodes: btn.querySelectorAll("[data-lucide]") });
        }, 15000);
      }

      async function pollTrainerDevices() {
        try {
          const resp = await fetch("/api/trainer/status");
          const data = await resp.json();
          const listEl = document.getElementById("trainerDeviceList");

          if (data.scannedDevices && data.scannedDevices.length > 0) {
            listEl.classList.remove("hidden");
            listEl.innerHTML = data.scannedDevices
              .map(
                (
                  d,
                ) => `<button onclick="trainerConnect('${d.address}')" class="w-full px-3 py-2 text-left text-sm rounded-lg bg-neutral-800/80 border border-neutral-700 hover:bg-amber-500/10 hover:border-amber-500/30 transition-colors flex items-center justify-between">
                <span class="text-neutral-300">${d.name}</span>
                <span class="text-[10px] text-neutral-500 font-mono">${d.rssi} dBm</span>
              </button>`,
              )
              .join("");
          }
        } catch (err) {
          console.error("Trainer poll error:", err);
        }
      }

      async function trainerConnect(address) {
        try {
          await fetch("/api/trainer/connect", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ address }),
          });
        } catch (err) {
          console.error("Trainer connect error:", err);
        }
      }

      async function trainerSetPower() {
        const input = document.getElementById("trainerPowerInput");
        const watts = parseInt(input.value);
        if (isNaN(watts) || watts < 0 || watts > 2000) {
          input.classList.add("border-red-500");
          setTimeout(() => input.classList.remove("border-red-500"), 1500);
          return;
        }
        try {
          const resp = await fetch("/api/trainer/power", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ watts }),
          });
          const result = await resp.json();
          if (result.success) {
            _currentTrainerTarget = watts;
            input.value = "";
          }
        } catch (err) {
          console.error("Trainer set power error:", err);
        }
      }

      function trainerQuickPower(watts) {
        fetch("/api/trainer/power", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ watts }),
        })
          .then((r) => r.json())
          .then((result) => {
            if (result.success) _currentTrainerTarget = watts;
          })
          .catch((err) => console.error("Quick power error:", err));
      }

      function trainerAdjustPower(delta) {
        const current = _currentTrainerTarget || 0;
        const newTarget = Math.max(0, Math.min(2000, current + delta));
        fetch("/api/trainer/power", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ watts: newTarget }),
        })
          .then((r) => r.json())
          .then((result) => {
            if (result.success) _currentTrainerTarget = newTarget;
          })
          .catch((err) => console.error("Adjust power error:", err));
      }

      async function trainerDisconnect() {
        try {
          await fetch("/api/trainer/disconnect", { method: "POST" });
          _currentTrainerTarget = null;
        } catch (err) {
          console.error("Trainer disconnect error:", err);
        }
      }
    </script>
  </body>
</html>
